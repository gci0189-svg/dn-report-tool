<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç¶­ä¿®å–®é™„ä»¶åˆæˆå™¨</title>
  <style>
    body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f4f4f9; padding: 20px; display: flex; justify-content: center;}
    .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
    h2 { text-align: center; color: #333; margin-top: 0;}
    .step { margin-bottom: 25px; }
    label { display: block; font-weight: bold; margin-bottom: 8px; color: #444; }
    input[type="file"] { display: block; width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 6px; box-sizing: border-box; background: #fafafa; cursor: pointer; }
    button { background: #0056b3; color: white; padding: 14px; border: none; width: 100%; cursor: pointer; font-size: 16px; border-radius: 6px; font-weight: bold; transition: background 0.3s;}
    button:hover { background: #004494; }
    #status { margin-top: 20px; font-weight: bold; text-align: center; font-size: 14px;}
  </style>

  <!-- è¼‰å…¥ç¬¬ä¸‰æ–¹å¥—ä»¶ -->
  <!-- pdf.js è² è²¬ã€Œè®€å–ã€ç¬¬ä¸€é çš„æ–‡å­— -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- pdf-lib è² è²¬ã€Œç·¨è¼¯èˆ‡ç•«åœ–ã€ï¼Œä¸¦ç”¢å‡ºæ–° PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <!-- fontkit è² è²¬è®“ PDF æ”¯æ´ã€Œä¸­æ–‡å­—é«”ã€ -->
  <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
</head>
<body>

  <div class="container">
    <h2>ğŸ› ï¸ ç¶­ä¿®å–®é™„ä»¶åˆæˆå™¨</h2>
    <p style="color: #666; font-size: 13px; text-align: center; margin-bottom: 20px;">
      (ä¿ç•™ç¬¬ä¸€é åŸç‰ˆç°½åï¼Œè‡ªå‹•ç”Ÿæˆç¬¬äºŒé è¡¨é ­èˆ‡ç…§ç‰‡)
    </p>

    <div class="step">
      <label>1. ä¸Šå‚³åŸç‰ˆç¶­ä¿®ç´€éŒ„ (PDF)</label>
      <input type="file" id="uploadPdf" accept="application/pdf">
    </div>

    <div class="step">
      <label>2. é™„åŠ æ©Ÿå°ç¾å ´ç…§ç‰‡ (JPG/PNG)</label>
      <input type="file" id="uploadPhoto" accept="image/*">
    </div>

    <button id="generateBtn">ç”¢ç”Ÿå®Œæ•´å ±è¡¨</button>
    <div id="status"></div>
  </div>

  <script>
// è¨­å®š PDF.js çš„ Worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    document.getElementById('generateBtn').addEventListener('click', async () => {
        const pdfFile = document.getElementById('uploadPdf').files[0];
        const photoFile = document.getElementById('uploadPhoto').files[0];
        const statusDiv = document.getElementById('status');

        if (!pdfFile || !photoFile) {
            statusDiv.innerText = "âš ï¸ éŒ¯èª¤ï¼šè«‹ç¢ºä¿ PDF èˆ‡ç…§ç‰‡éƒ½å·²ä¸Šå‚³ï¼";
            statusDiv.style.color = "red";
            return;
        }

        statusDiv.innerText = "â³ æ­£åœ¨å•Ÿå‹•åƒç´ ç´šåˆæˆï¼Œè«‹ç¨å€™...";
        statusDiv.style.color = "blue";

        try {
            // ==========================================
            // æ­¥é©Ÿ Aï¼šè®€å–æ–‡å­—ï¼Œç²¾æº–æŠ“è™Ÿç¢¼
            // ==========================================
            const pdfArrayBuffer = await pdfFile.arrayBuffer();
            const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfArrayBuffer }).promise;
            const page = await pdfJsDoc.getPage(1);
            const textContent = await page.getTextContent();
            const fullText = textContent.items.map(item => item.str).join(' ');

            const ticketMatch = fullText.match(/å ±æ¡ˆæµæ°´è™Ÿ[^\d]*(\d+)/);
            const taskMatch = fullText.match(/ä»»å‹™\s*No[^\d]*(\d+)/i); 
            const ticketNo = ticketMatch ? ticketMatch[1] : "";
            const taskNo = taskMatch ? taskMatch[1] : "";

            // ==========================================
            // æ­¥é©Ÿ Bï¼šä½¿ç”¨ pdf-lib é–‹å§‹ä¿®æ”¹ PDF
            // ==========================================
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
            const pdfDoc = await PDFDocument.load(pdfArrayBuffer);

            // è¨»å†Šå­—é«”
            pdfDoc.registerFontkit(fontkit);
            // è‹±æ–‡ä½¿ç”¨ Helvetica (æœ€æ¥è¿‘ç³»çµ± Arial)
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
            // ä¸­æ–‡åŠ è¼‰é»‘é«”
            const fontUrl = 'https://cdn.jsdelivr.net/gh/googlefonts/noto-cjk/Sans/OTF/TraditionalChinese/NotoSansCJKtc-Regular.otf';
            const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
            const customFont = await pdfDoc.embedFont(fontBytes);

            const newPage = pdfDoc.addPage([595.28, 841.89]);

            // ==========================================
            // æ­¥é©Ÿ Cï¼šã€ä¼æ¥­å ±è¡¨ç³»çµ± åƒç´ ç´šæ’ç‰ˆã€‘
            // ==========================================
            
            const marginL = 42;           // å·¦é‚Šç•Œ (ä¾æ“šæˆªåœ–ç¨å¾®å¾€å·¦æ¨)
            const marginR = 553;          // å³é‚Šç•Œ (ä¾æ“šæˆªåœ–ç¨å¾®å¾€å³æ¨)
            
            // 1. å·¦å´æ¨™é¡Œ (ç²¾æº–å°ºå¯¸èˆ‡é–“è·)
            newPage.drawText('Diebold Nixdorf', { x: marginL, y: 782, size: 15, font: helveticaFont, color: rgb(0, 0, 0) });
            newPage.drawText('ç¶­ä¿®ç´€éŒ„', { x: marginL, y: 757, size: 19, font: customFont, color: rgb(0, 0, 0) });

            // 2. è¡¨æ ¼åƒæ•¸ (æ¨¡ä»¿èˆŠç‰ˆç³»çµ±çš„å‰›ç¡¬æ„Ÿ)
            const tableW = 275;           // è¡¨æ ¼ç¸½å¯¬åº¦
            const tableX = marginR - tableW; // Xåº§æ¨™è²¼é½Šå³å´
            const tableTopY = 800;        // é ‚éƒ¨å°é½Šé»
            const rowH = 17.5;            // åˆ—é«˜ (ç²¾æº– 17.5pt)
            const tableBottomY = tableTopY - (rowH * 3); // 747.5
            const colSplit = 100;         // å·¦æ¬„å¯¬åº¦

            // ç•«è¡¨æ ¼å¤–æ¡†èˆ‡ç·šæ¢ (æ¨™æº– 0.5pt ç´°é»‘ç·šï¼Œæœ€æœ‰ç³»çµ±æ„Ÿ)
            const lineThick = 0.5;
            newPage.drawRectangle({ x: tableX, y: tableBottomY, width: tableW, height: rowH * 3, borderColor: rgb(0, 0, 0), borderWidth: lineThick });
            newPage.drawLine({ start: { x: tableX, y: tableTopY - rowH }, end: { x: tableX + tableW, y: tableTopY - rowH }, thickness: lineThick, color: rgb(0, 0, 0) });
            newPage.drawLine({ start: { x: tableX, y: tableTopY - (rowH * 2) }, end: { x: tableX + tableW, y: tableTopY - (rowH * 2) }, thickness: lineThick, color: rgb(0, 0, 0) });
            newPage.drawLine({ start: { x: tableX + colSplit, y: tableBottomY }, end: { x: tableX + colSplit, y: tableTopY }, thickness: lineThick, color: rgb(0, 0, 0) });

            // 3. å¡«å…¥è¡¨æ ¼æ–‡å­— (ç²¾æº–å‚ç›´ç½®ä¸­æ¼”ç®—æ³•)
            const fontSize = 10.5;
            // Yè»¸åç§»é‡ = åˆ—é«˜çš„ä¸€åŠ - å­—é«”å¤§å°çš„ä¸€åŠ (è®“æ–‡å­—å®Œç¾åœ¨æ ¼å­æ­£ä¸­é–“)
            const textOffsetY = (rowH / 2) - (fontSize / 2.8); 
            
            const textY1 = tableTopY - rowH + textOffsetY;
            const textY2 = tableTopY - (rowH * 2) + textOffsetY;
            const textY3 = tableBottomY + textOffsetY;

            // å·¦æ¬„ä¸­æ–‡
            newPage.drawText('å ±æ¡ˆæµæ°´è™Ÿ', { x: tableX + 22, y: textY1, size: fontSize, font: customFont });
            newPage.drawText('ä»»å‹™ No.',   { x: tableX + 29, y: textY2, size: fontSize, font: customFont });
            newPage.drawText('å€¼ç­ No.',   { x: tableX + 29, y: textY3, size: fontSize, font: customFont });

            // å³æ¬„æ•¸å­— (Helvetica, ç·Šè²¼å·¦å´)
            const valueX = tableX + colSplit + 5;
            newPage.drawText(ticketNo, { x: valueX, y: textY1, size: fontSize + 0.5, font: helveticaFont });
            newPage.drawText(taskNo,   { x: valueX, y: textY2, size: fontSize + 0.5, font: helveticaFont });

            // 4. åº•éƒ¨çš„é»‘è‰²é•·åˆ†éš”ç·š (ç²—åº¦ 0.5ï¼Œç²¾æº–åˆ‡é½Š)
            newPage.drawLine({ start: { x: marginL, y: 735 }, end: { x: marginR, y: 735 }, thickness: lineThick, color: rgb(0, 0, 0) });

            // ==========================================
            // æ­¥é©Ÿ Dï¼šæ’å…¥æ©Ÿå°ç…§ç‰‡ (è‡ªå‹•ç¸®æ”¾èˆ‡ç½®ä¸­)
            // ==========================================
            const photoArrayBuffer = await photoFile.arrayBuffer();
            let image;
            if (photoFile.type === 'image/jpeg') {
                image = await pdfDoc.embedJpg(photoArrayBuffer);
            } else if (photoFile.type === 'image/png') {
                image = await pdfDoc.embedPng(photoArrayBuffer);
            } else {
                throw new Error("åªæ”¯æ´ JPG æˆ– PNG æ ¼å¼ï¼");
            }

            const scaledDims = image.scaleToFit(380, 520);
            const imgX = (595.28 - scaledDims.width) / 2;
            const imgY = 715 - scaledDims.height; 

            newPage.drawImage(image, { x: imgX, y: imgY, width: scaledDims.width, height: scaledDims.height });

            // ==========================================
            // æ­¥é©Ÿ Eï¼šæ‰“åŒ…ä¸‹è¼‰
            // ==========================================
            const modifiedPdfBytes = await pdfDoc.save();
            const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç¶­ä¿®ç´€éŒ„_${ticketNo}_å«é™„ä»¶.pdf`;
            link.click();

            statusDiv.innerText = `âœ… æˆåŠŸï¼å·²æŠ“å– æµæ°´è™Ÿ: ${ticketNo} / ä»»å‹™è™Ÿ: ${taskNo}`;
            statusDiv.style.color = "green";

        } catch (error) {
            console.error(error);
            statusDiv.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message;
            statusDiv.style.color = "red";
        }
    });
  </script>
</body>
</html>