<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç¶­ä¿®å–®é™„ä»¶åˆæˆå™¨ - å®Œç¾è¤‡åˆ»ç‰ˆ</title>
  <style>
    body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f0f2f5; padding: 40px; display: flex; justify-content: center; }
    .container { background: white; padding: 35px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); width: 100%; max-width: 550px; }
    h2 { text-align: center; color: #1a1a1a; margin-bottom: 30px; letter-spacing: 1px; }
    .step { margin-bottom: 25px; }
    label { display: block; font-weight: 600; margin-bottom: 10px; color: #444; }
    input[type="file"] { display: block; width: 100%; padding: 12px; border: 2px dashed #cbd5e0; border-radius: 8px; cursor: pointer; background: #fafafa; }
    button { background: #004a99; color: white; padding: 16px; border: none; width: 100%; cursor: pointer; font-size: 17px; border-radius: 8px; font-weight: bold; transition: all 0.3s; margin-top: 10px; }
    button:hover { background: #003366; transform: translateY(-1px); }
    #status { margin-top: 25px; font-weight: 500; text-align: center; min-height: 20px; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
</head>
<body>

  <div class="container">
    <h2>ğŸ› ï¸ ç¶­ä¿®ç´€éŒ„é™„ä»¶åˆæˆå™¨</h2>
    
    <div class="step">
      <label>1. ä¸Šå‚³åŸç‰ˆç¶­ä¿®ç´€éŒ„ (PDF)</label>
      <input type="file" id="uploadPdf" accept="application/pdf">
    </div>

    <div class="step">
      <label>2. é™„åŠ æ©Ÿå°ç¾å ´ç…§ç‰‡ (JPG/PNG)</label>
      <input type="file" id="uploadPhoto" accept="image/*">
    </div>

    <button id="generateBtn">ç”¢ç”Ÿå®Œæ•´å ±è¡¨</button>
    <div id="status"></div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    document.getElementById('generateBtn').addEventListener('click', async () => {
        const pdfFile = document.getElementById('uploadPdf').files[0];
        const photoFile = document.getElementById('uploadPhoto').files[0];
        const statusDiv = document.getElementById('status');

        if (!pdfFile || !photoFile) {
            statusDiv.innerText = "âš ï¸ è«‹ç¢ºä¿ PDF èˆ‡ç…§ç‰‡éƒ½å·²æ­£ç¢ºä¸Šå‚³ï¼";
            statusDiv.style.color = "#e53e3e";
            return;
        }

        statusDiv.innerText = "â³ æ­£åœ¨é€²è¡Œåƒç´ ç´šæ’ç‰ˆï¼Œè«‹ç¨å€™...";
        statusDiv.style.color = "#3182ce";

        try {
            // è®€å–ç¬¬ä¸€é è³‡è¨Š [cite: 101]
            const pdfArrayBuffer = await pdfFile.arrayBuffer();
            const pdfJsDoc = await pdfjsLib.getDocument({ data: pdfArrayBuffer }).promise;
            const page1 = await pdfJsDoc.getPage(1);
            const textContent = await page1.getTextContent();
            const fullText = textContent.items.map(item => item.str).join(' ');

            // ç²¾ç¢ºæ­£å‰‡è¡¨é”å¼ 
            const ticketNo = (fullText.match(/å ±æ¡ˆæµæ°´è™Ÿ\s*[:ï¼š]?\s*(\d+)/) || ["", ""])[1];
            const taskNo = (fullText.match(/ä»»å‹™\s*No\.?\s*(\d+)/i) || ["", ""])[1];

            // å•Ÿå‹• pdf-lib
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
            const pdfDoc = await PDFDocument.load(pdfArrayBuffer);
            pdfDoc.registerFontkit(fontkit);

            // å­—é«”åŠ è¼‰ (Noto Sans CJK TC) [cite: 146]
            const fontUrl = 'https://cdn.jsdelivr.net/gh/googlefonts/noto-cjk/Sans/OTF/TraditionalChinese/NotoSansCJKtc-Regular.otf';
            const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
            const customFont = await pdfDoc.embedFont(fontBytes);
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);

            // æ–°å¢ç¬¬äºŒé  (A4 å°ºå¯¸)
            const newPage = pdfDoc.addPage([595.28, 841.89]);
            
            // --- åƒç´ ç´šæ’ç‰ˆåƒæ•¸ --- 
            const marginL = 42.5; 
            const marginR = 552.8;
            const tableW = 265;
            const tableX = marginR - tableW;
            const tableTopY = 802;
            const rowH = 18.2; // ç²¾ç¢ºè¡Œé«˜
            const lineThick = 0.6;

            // 1. å·¦å´æ¨™é¡Œå€åŸŸ [cite: 146]
            newPage.drawText('Diebold Nixdorf', { x: marginL, y: 785, size: 14.5, font: helveticaFont });
            newPage.drawText('ç¶­ä¿®ç´€éŒ„', { x: marginL, y: 758, size: 19.5, font: customFont });

            // 2. å³å´è¡¨æ ¼é‚Šæ¡†èˆ‡æ ¼ç·š 
            newPage.drawRectangle({ 
                x: tableX, y: tableTopY - (rowH * 3), 
                width: tableW, height: rowH * 3, 
                borderColor: rgb(0, 0, 0), borderWidth: lineThick 
            });
            for (let i = 1; i <= 2; i++) {
                newPage.drawLine({
                    start: { x: tableX, y: tableTopY - (rowH * i) },
                    end: { x: tableX + tableW, y: tableTopY - (rowH * i) },
                    thickness: lineThick, color: rgb(0, 0, 0)
                });
            }
            newPage.drawLine({
                start: { x: tableX + 95, y: tableTopY - (rowH * 3) },
                end: { x: tableX + 95, y: tableTopY },
                thickness: lineThick, color: rgb(0, 0, 0)
            });

            // 3. å¡«å……è¡¨æ ¼æ–‡å­— 
            const fontSize = 10.2;
            const textYOffset = 6.8; // å‚ç›´ç½®ä¸­ä¿®æ­£
            
            const drawCell = (label, value, rowIdx) => {
                const y = tableTopY - (rowH * rowIdx) - rowH + textYOffset;
                newPage.drawText(label, { x: tableX + 10, y, size: fontSize, font: customFont });
                if (value) {
                    newPage.drawText(value, { x: tableX + 103, y, size: fontSize + 0.3, font: helveticaFont });
                }
            };

            drawCell('å ±æ¡ˆæµæ°´è™Ÿ', ticketNo, 0);
            drawCell('ä»»å‹™ No.', taskNo, 1);
            drawCell('å€¼ç­ No.', '', 2);

            // 4. åº•éƒ¨é•·æ©«ç·š 
            newPage.drawLine({ 
                start: { x: marginL, y: 738 }, 
                end: { x: marginR, y: 738 }, 
                thickness: 0.8, color: rgb(0, 0, 0) 
            });

            // 5. è™•ç†ä¸¦æ’å…¥ç…§ç‰‡
            const photoArrayBuffer = await photoFile.arrayBuffer();
            let image = photoFile.type === 'image/jpeg' ? await pdfDoc.embedJpg(photoArrayBuffer) : await pdfDoc.embedPng(photoArrayBuffer);

            const maxImgW = 510;
            const maxImgH = 650;
            const scaled = image.scaleToFit(maxImgW, maxImgH);
            
            newPage.drawImage(image, {
                x: (595.28 - scaled.width) / 2,
                y: 720 - scaled.height,
                width: scaled.width,
                height: scaled.height
            });

            // å­˜æª”èˆ‡ä¸‹è¼‰
            const modifiedPdfBytes = await pdfDoc.save();
            const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç¶­ä¿®ç´€éŒ„_${ticketNo}_å«é™„ä»¶.pdf`;
            link.click();

            statusDiv.innerText = `âœ… å®Œæˆï¼æµæ°´è™Ÿï¼š${ticketNo}`;
            statusDiv.style.color = "#38a169";

        } catch (error) {
            console.error(error);
            statusDiv.innerText = "âŒ è™•ç†å¤±æ•—ï¼š" + error.message;
            statusDiv.style.color = "#e53e3e";
        }
    });
  </script>
</body>
</html>
